name: windows-release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Optional tag to release (defaults to auto-generated manual tag)"
        required: false
      release_name:
        description: "Optional release name override"
        required: false

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine release metadata
        id: metadata
        shell: pwsh
        run: |
          $eventName = "${{ github.event_name }}"
          if ($eventName -eq "workflow_dispatch") {
            $tag = "${{ github.event.inputs.tag_name }}".Trim()
            if ([string]::IsNullOrEmpty($tag)) {
              $tag = "manual-v${{ github.run_number }}"
            }
            $releaseName = "${{ github.event.inputs.release_name }}".Trim()
            if ([string]::IsNullOrEmpty($releaseName)) {
              $releaseName = "Manual build $tag"
            }
          }
          else {
            $tag = "${{ github.ref }}".Split('/')[-1]
            $releaseName = "Release $tag"
          }

          "RELEASE_TAG=$tag" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "RELEASE_NAME=$releaseName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build hello-windows.exe
        shell: pwsh
        run: cl /nologo /O2 /EHsc src\hello-windows.cpp /Fe:hello-windows.exe

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: hello-windows-exe
          path: hello-windows.exe

      - name: Create GitHub release and upload asset
        uses: softprops/action-gh-release@v2
        with:
          files: hello-windows.exe
          fail_on_unmatched_files: true
          generate_release_notes: true
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
