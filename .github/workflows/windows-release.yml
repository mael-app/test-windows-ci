name: windows-release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Optional tag to release (defaults to auto-generated manual tag)"
        required: false
      release_name:
        description: "Optional release name override"
        required: false

permissions:
  contents: write

env:
  APP_NAME: hello-windows

jobs:
  prepare-metadata:
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
      package_version: ${{ steps.meta.outputs.package_version }}
    steps:
      - name: Resolve release metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          event_name="${{ github.event_name }}"
          if [ "$event_name" = "workflow_dispatch" ]; then
            tag_input="${{ github.event.inputs.tag_name }}"
            release_input="${{ github.event.inputs.release_name }}"
            tag=$(echo "$tag_input" | xargs)
            if [ -z "$tag" ]; then
              tag="manual-v${GITHUB_RUN_NUMBER}"
            fi
            release_name=$(echo "$release_input" | xargs)
            if [ -z "$release_name" ]; then
              release_name="Manual build $tag"
            fi
          else
            ref_name="${GITHUB_REF##*/}"
            tag="$ref_name"
            release_name="Release $tag"
          fi

          pkg_version="${tag#v}"
          if [ -z "$pkg_version" ]; then
            pkg_version="0.0.0"
          fi

          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=$release_name" >> "$GITHUB_OUTPUT"
          echo "package_version=$pkg_version" >> "$GITHUB_OUTPUT"

  build-windows:
    runs-on: windows-latest
    needs: prepare-metadata
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSVC environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Build hello-windows.exe
        shell: pwsh
        run: cl /nologo /O2 /EHsc src\hello-windows.cpp /Fe:hello-windows.exe

      - name: Stage Windows artifact
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null
          Copy-Item hello-windows.exe dist/${{ env.APP_NAME }}-windows.exe

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: hello-windows-windows
          path: dist/*

  build-linux:
    runs-on: ubuntu-latest
    needs: prepare-metadata
    env:
      PACKAGE_VERSION: ${{ needs.prepare-metadata.outputs.package_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Linux binary
        run: g++ src/hello-windows.cpp -std=c++17 -O2 -o hello-windows

      - name: Install fpm
        run: sudo gem install --no-document fpm

      - name: Package Linux artifacts
        run: |
          set -euo pipefail
          APP="$APP_NAME"
          VERSION="$PACKAGE_VERSION"
          mkdir -p dist

          # Plain binary + tarball
          cp hello-windows "dist/${APP}-linux"
          tar czf "dist/${APP}-linux.tar.gz" -C dist "${APP}-linux"

          # Prepare staging tree for packages
          STAGE="package/usr/local/bin"
          mkdir -p "$STAGE"
          cp hello-windows "$STAGE/$APP"

          fpm -s dir -t deb \
              -n "$APP" \
              -v "$VERSION" \
              --architecture amd64 \
              --package "dist/${APP}_${VERSION}_amd64.deb" \
              -C package usr/local/bin/$APP

          fpm -s dir -t rpm \
              -n "$APP" \
              -v "$VERSION" \
              --architecture x86_64 \
              --package "dist/${APP}-${VERSION}-1.x86_64.rpm" \
              -C package usr/local/bin/$APP

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hello-windows-linux
          path: dist/*

  build-macos:
    runs-on: macos-latest
    needs: prepare-metadata
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build macOS binary
        run: clang++ src/hello-windows.cpp -std=c++17 -O2 -o hello-windows

      - name: Stage macOS artifact
        run: |
          set -euo pipefail
          mkdir -p dist
          cp hello-windows "dist/${APP_NAME}-macos"
          cd dist
          zip -r "${APP_NAME}-macos.zip" "${APP_NAME}-macos"
          rm "${APP_NAME}-macos"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: hello-windows-macos
          path: dist/*

  publish-release:
    runs-on: ubuntu-latest
    needs:
      - prepare-metadata
      - build-windows
      - build-linux
      - build-macos
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-dist
          pattern: hello-windows-*
          merge-multiple: true

      - name: List release assets
        run: ls -R release-dist

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: release-dist/*
          fail_on_unmatched_files: true
          generate_release_notes: true
          tag_name: ${{ needs.prepare-metadata.outputs.release_tag }}
          name: ${{ needs.prepare-metadata.outputs.release_name }}
          target_commitish: ${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
